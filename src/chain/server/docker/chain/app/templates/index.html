<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Chain Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üß™ „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">ÔºãËøΩÂä†</button>
        </div>

        <div class="row">
            {% for project in projects %}
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h4 class="text-dark">{{ project['name'] }}</h4>
                        <p class="text-secondary">Project ID: {{ project['id'] }}</p>
                        <div class="row g-2 mt-2">
                            <!-- ‰∏äÊÆµÔºö„Ç¢„ÇØ„Çª„Çπ„Ç≠„Éº„Å®ÂâäÈô§ -->
                            <div class="col-md-6">
                                <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#accessKeyModal"
                                        data-prj-id="{{ project['id'] }}"
                                        mlflow-uri="{{ project['mlflow-uri'] }}"
                                        optuna-uri="{{ project['optuna-uri'] }}"
                                        dvc-uri="{{ project['dvc-uri'] }}"
                                        chaser-uri="{{ project['chaser-uri'] }}">
                                    „Ç¢„ÇØ„Çª„Çπ„Ç≠„Éº
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-danger w-100"
                                        data-bs-toggle="modal"
                                        data-bs-target="#removeConfirmModal"
                                        data-prj-id="{{ project['id'] }}"
                                        data-prj-name="{{ project['name'] }}">
                                    ÂâäÈô§
                                </button>
                            </div>

                            <!-- ‰∏ãÊÆµÔºöMLFlow / Optuna / Chaser -->
                            <div class="col-md-4">
                                <a href="{{ url_for('mlflow_server', prj_id=project['id']) }}" class="btn btn-success w-100">MLFlow</a>
                            </div>
                            <div class="col-md-4">
                                <a href="{{ url_for('optuna_server', prj_id=project['id']) }}" class="btn btn-success w-100">Optuna</a>
                            </div>
                            <div class="col-md-4">
                                <a href="{{ url_for('chaser_server', prj_id=project['id']) }}" class="btn btn-success w-100">Chaser</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ÔºöËøΩÂä† -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action="{{ url_for('add_project') }}" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="prj_name" class="form-control" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´Ôºö„Ç¢„ÇØ„Çª„Çπ„Ç≠„Éº -->
    <div class="modal fade" id="accessKeyModal" tabindex="-1" aria-labelledby="accessKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accessKeyModalLabel">„Ç¢„ÇØ„Çª„Çπ„Ç≠„Éº„Çí„Ç≥„Éî„Éº</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
                </div>
                <div class="modal-body">
                    {% for title, key in [("MLflow Tracking URI", "mlflow"), ("Chain Tracking URI","chaser"), ("Optuna Tracking URI", "optuna"), ("DVC Remote URI", "dvc")] %}
                        <div class="mb-3">
                            <label class="form-label">{{ title }}</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="projIdInput-{{ key }}" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ key }}')">„Ç≥„Éî„Éº</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="removeConfirmModal" tabindex="-1" aria-labelledby="removeConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="{{ url_for('remove_project') }}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="removeConfirmModalLabel">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂâäÈô§Á¢∫Ë™ç</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong id="removeTargetName"></strong> „ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
                        <input type="hidden" name="prj_id" id="removeTargetId">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit" class="btn btn-danger">ÂâäÈô§ÂÆüË°å</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const accessKeyModal = document.getElementById('accessKeyModal');
    accessKeyModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const dataprojid = button.getAttribute('data-prj-id');
        const mlflowuri = button.getAttribute('mlflow-uri');
        const optunauri = button.getAttribute('optuna-uri');
        const dvcuri = button.getAttribute('dvc-uri');
        const chaseruri = button.getAttribute('chaser-uri');
        // „Åù„Çå„Åû„Çå„ÅÆÁî®ÈÄî„Å´Âøú„Åò„ÅüID„Çí‰ªÆ„Å´ÁµÑ„ÅøÁ´ã„Å¶„Çã‰æã
        document.getElementById('projIdInput-mlflow').value = `${mlflowuri}`;
        document.getElementById('projIdInput-optuna').value = `${optunauri}`;
        document.getElementById('projIdInput-dvc').value = `${dvcuri}`;
        document.getElementById('projIdInput-chaser').value = `${chaseruri}`;
    });

    function copyToClipboard(key) {
        const input = document.getElementById(`projIdInput-${key}`);
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand("copy");
        alert(`${key.toUpperCase()} „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: ` + input.value);
    }

    const removeModal = document.getElementById('removeConfirmModal');
    removeModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const projId = button.getAttribute('data-prj-id');
        const projName = button.getAttribute('data-prj-name');
        document.getElementById('removeTargetName').textContent = projName;
        document.getElementById('removeTargetId').value = projId;
    });
    </script>

</body>
</html>
